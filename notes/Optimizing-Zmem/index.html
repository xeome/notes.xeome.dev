<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Introduction: In my quest to find a reliable tool that can show per-process swap usage, I stumbled upon a program called smem."><meta property="og:title" content="Supercharging zmem, A Journey of Optimizing My Rust Program"><meta property="og:description" content="Introduction: In my quest to find a reliable tool that can show per-process swap usage, I stumbled upon a program called smem."><meta property="og:type" content="website"><meta property="og:image" content="https://notes.xeome.dev/icon.png"><meta property="og:url" content="https://notes.xeome.dev/notes/Optimizing-Zmem/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Supercharging zmem, A Journey of Optimizing My Rust Program"><meta name=twitter:description content="Introduction: In my quest to find a reliable tool that can show per-process swap usage, I stumbled upon a program called smem."><meta name=twitter:image content="https://notes.xeome.dev/icon.png"><title>Supercharging zmem, A Journey of Optimizing My Rust Program</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://notes.xeome.dev//icon.png><link href=https://notes.xeome.dev/styles.56fda312aefe26efb1fe5fe56affb512.min.css rel=stylesheet><link href=https://notes.xeome.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://notes.xeome.dev/js/darkmode.b9ef4dec7f4deb8d31837b84274c5377.min.js></script>
<script src=https://notes.xeome.dev/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://notes.xeome.dev/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://notes.xeome.dev/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://notes.xeome.dev/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://notes.xeome.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://notes.xeome.dev/",fetchData=Promise.all([fetch("https://notes.xeome.dev/indices/linkIndex.0b7e461c95617498f89ae9a10b227cc3.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://notes.xeome.dev/indices/contentIndex.7933b109a2f394cb55f201bff3786f54.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://notes.xeome.dev",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://notes.xeome.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:.5,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:4,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/notes.xeome.dev\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=notes.xeome.dev src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://notes.xeome.dev/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://notes.xeome.dev/>Xeome's Notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Supercharging zmem, A Journey of Optimizing My Rust Program</h1><p class=meta>Last updated
May 20, 2023
<a href=https://github.com/xeome/xeome.github.io/tree/hugo/content/notes/Optimizing%20Zmem.md rel=noopener>Edit Source</a></p><ul class=tags></ul><a href=#introduction><h2 id=introduction><span class=hanchor arialabel=Anchor># </span>Introduction:</h2></a><p>In my quest to find a reliable tool that can show per-process swap usage, I stumbled upon a program called <code>smem</code>. Although <code>smem</code> does the job well, it took around 1.5 seconds to run, with the runtime depending on the number of open processes. <code>smem</code> works by parsing <code>/proc/&lt;pid>/smaps</code> and summing specific fields. To improve upon this, I developed my own version called <code>zmem</code>, inspired by memory management mechanics like <code>zram</code> and <code>zswap</code>. My initial Rust implementation already showed a significant performance boost, taking approximately 600ms to run. However, I wanted to optimize it further to create a continuous monitoring software. In this blog post, I will describe my journey of optimizing
<a href=https://github.com/xeome/Zmem rel=noopener>zmem</a> and the techniques I employed to achieve it.</p><a href=#initial-rust-implementation><h2 id=initial-rust-implementation><span class=hanchor arialabel=Anchor># </span>Initial Rust Implementation:</h2></a><p>As a newcomer to Rust, I started by writing a simple implementation of <code>zmem</code>. I followed a similar approach as <code>smem</code>, but aimed to optimize it from the very beginning. My initial implementation took around 600ms to run, which was already a significant improvement over <code>smem</code>. However, I wanted to push the limits and achieve even better performance.</p><p>Here&rsquo;s a snippet of the initial implementation:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ProcessMemoryStats</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>pid</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>username</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>command</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>swap</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>uss</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>pss</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>rss</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>ProcessMemoryStats</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pid</span>: <span class=kt>u32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AnyError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>File</span>::<span class=n>open</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;/proc/{}/cmdline&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>))</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>contents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>file</span><span class=p>.</span><span class=n>read_to_string</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>contents</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>contents</span><span class=p>.</span><span class=n>replace</span><span class=p>(</span><span class=s>&#34;\0&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>command</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>50</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>command</span><span class=p>.</span><span class=n>truncate</span><span class=p>(</span><span class=mi>50</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>File</span>::<span class=n>open</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;/proc/{}/smaps&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>))</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>contents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>file</span><span class=p>.</span><span class=n>read_to_string</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>contents</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>lines</span>: <span class=nb>Vec</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>contents</span><span class=p>.</span><span class=n>lines</span><span class=p>().</span><span class=n>collect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>lines</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>split</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=n>split_whitespace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>split</span><span class=p>.</span><span class=n>next</span><span class=p>().</span><span class=n>ok_or</span><span class=p>(</span><span class=s>&#34;bad file format&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>split</span><span class=p>.</span><span class=n>next</span><span class=p>().</span><span class=n>ok_or</span><span class=p>(</span><span class=s>&#34;bad file format&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Swap:&#34;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>swap</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>()</span><span class=o>?</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Pss:&#34;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=n>parse</span><span class=p>()</span><span class=o>?</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Rss:&#34;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>rss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=n>parse</span><span class=p>()</span><span class=o>?</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Private_Clean:&#34;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>uss</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>()</span><span class=o>?</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Private_Dirty:&#34;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>uss</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>()</span><span class=o>?</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#profiling-with-cargo-flamegraphs><h2 id=profiling-with-cargo-flamegraphs><span class=hanchor arialabel=Anchor># </span>Profiling with Cargo Flamegraphs:</h2></a><p>To identify bottlenecks in my code, I turned to Cargo&rsquo;s built-in flamegraphs. Generating a flamegraph was as easy as running <code>cargo flamegraph</code>. The flamegraph helped me visualize the performance of different parts of my code.</p><a href=#optimizing-update-function><h2 id=optimizing-update-function><span class=hanchor arialabel=Anchor># </span>Optimizing Update Function:</h2></a><p>One of the first issues I discovered was that I was calling the update function twice, without any apparent reason. By removing one of the redundant calls, I managed to bring the runtime down to around 300ms.</p><p><img src="/notes/assets/img/0_Pasted image 20230430222955.png" width=auto></p><a href=#parallelizing-update-function><h2 id=parallelizing-update-function><span class=hanchor arialabel=Anchor># </span>Parallelizing Update Function:</h2></a><p>Next, I parallelized the Update function using tokio, so that each reading operation on <code>/proc/&lt;pid>/smaps</code> was performed asynchronously. This change resulted in a significant performance improvement, reducing the runtime to just 70ms.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>update</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AnyError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>processes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>fs</span>::<span class=n>read_dir</span><span class=p>(</span><span class=s>&#34;/proc&#34;</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>let</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>let</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>file_name</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>into_string</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>unwrap_or_else</span><span class=p>(</span><span class=o>|</span><span class=n>_</span><span class=o>|</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pid</span><span class=p>.</span><span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>command</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Process</span>::<span class=n>get_cmd</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>command</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=bp>Self</span>::<span class=n>can_read_file</span><span class=p>(</span><span class=o>&amp;</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;/proc/{}/smaps&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=kd>let</span><span class=w> </span><span class=n>process_fut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Process</span>::<span class=n>new</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=kd>let</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span>::<span class=n>spawn</span><span class=p>(</span><span class=n>process_fut</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=n>processes</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>process</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>processes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>futures</span>::<span class=n>future</span>::<span class=n>join_all</span><span class=p>(</span><span class=n>processes</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>processes</span><span class=p>.</span><span class=n>sort_by</span><span class=p>(</span><span class=o>|</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>a</span><span class=p>.</span><span class=n>as_ref</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>swap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=n>cmp</span><span class=p>(</span><span class=o>&amp;</span><span class=n>b</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>unwrap</span><span class=p>().</span><span class=n>memory</span><span class=p>.</span><span class=n>swap</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=bp>self</span><span class=p>.</span><span class=n>processes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>processes</span><span class=p>.</span><span class=n>into_iter</span><span class=p>().</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=n>p</span><span class=o>|</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>unwrap</span><span class=p>()).</span><span class=n>collect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>All I did was make the call to new process asynchronous.</p><a href=#improving-data-locality><h2 id=improving-data-locality><span class=hanchor arialabel=Anchor># </span>Improving Data Locality:</h2></a><p>In an effort to further optimize the program, I added local variables where resources were being summed after parsing the smaps file. By doing this, I improved data locality, which in turn improved the performance of my code.</p><p><img src="/notes/assets/img/O_Pasted image 20230430224031.png" width=auto></p><a href=#including-debug-information><h2 id=including-debug-information><span class=hanchor arialabel=Anchor># </span>Including Debug Information:</h2></a><p>I realized that my release profile did not include debug information, which limited the output of the flamegraphs and excluded a lot of symbol data. By adding <code>debug=true</code> to the release profile, I was able to obtain more detailed information about which parts of my program were taking longer to execute.</p><a href=#utilizing-filter_map-and-reusing-string><h2 id=utilizing-filter_map-and-reusing-string><span class=hanchor arialabel=Anchor># </span>Utilizing <code>filter_map</code> and Reusing String:</h2></a><p>To further optimize my code and make it cleaner, I started using <code>filter_map</code> in some sections. Additionally, I realized I was creating a new <code>line</code> string for each iteration, leading to repeated calls to the allocator. By reusing the same string and clearing it after each iteration, I managed to improve performance by 5-10%.</p><p><img src="/notes/assets/img/O_Pasted image 20230430224602.png" width=auto></p><a href=#switching-to-smaps_rollup><h2 id=switching-to-smaps_rollup><span class=hanchor arialabel=Anchor># </span>Switching to <code>smaps_rollup</code>:</h2></a><p>While implementing smaps to read data about processes, I initially assumed that it was the best option available. However, during my research, I discovered that the slowness of smaps had been a concern for others as well. To further complicate things, I found out that the default value of kernel.perf_event_paranoid was 2, which made my flamegraphs inaccurate. After setting it to 1, I noticed that the call to <code>__show_smap</code> was taking the most time. For more information about the kernel.perf_event_paranoid sysctl value, refer to
<a href=https://sysctl-explorer.net/kernel/perf_event_paranoid/ rel=noopener>https://sysctl-explorer.net/kernel/perf_event_paranoid/</a>.</p><p>Before:
<img src="/notes/assets/img/O_Pasted image 20230430232805.png" width=auto></p><p>After:
<img src="/notes/assets/img/O_Pasted image 20230430232857.png" width=auto></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cm>/* Show the contents common for smaps and smaps_rollup */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__show_smap</span><span class=p>(</span><span class=k>struct</span> <span class=n>seq_file</span> <span class=o>*</span><span class=n>m</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>mem_size_stats</span> <span class=o>*</span><span class=n>mss</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=n>rollup_mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34;Rss:            &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>resident</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Pss:            &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>pss</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Pss_Dirty:      &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>pss_dirty</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>rollup_mode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>		 * These are meaningful only for smaps_rollup, otherwise two of
</span></span></span><span class=line><span class=cl><span class=cm>		 * them are zero, and the other one is the same as Pss.
</span></span></span><span class=line><span class=cl><span class=cm>		 */</span>
</span></span><span class=line><span class=cl>		<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Pss_Anon:       &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>mss</span><span class=o>-&gt;</span><span class=n>pss_anon</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Pss_File:       &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>mss</span><span class=o>-&gt;</span><span class=n>pss_file</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Pss_Shmem:      &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>mss</span><span class=o>-&gt;</span><span class=n>pss_shmem</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Shared_Clean:   &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>shared_clean</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Shared_Dirty:   &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>shared_dirty</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Private_Clean:  &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>private_clean</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Private_Dirty:  &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>private_dirty</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Referenced:     &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>referenced</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Anonymous:      &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>anonymous</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>LazyFree:       &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>lazyfree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>AnonHugePages:  &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>anonymous_thp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>ShmemPmdMapped: &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>shmem_thp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>FilePmdMapped:  &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>file_thp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Shared_Hugetlb: &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>shared_hugetlb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>seq_put_decimal_ull_width</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Private_Hugetlb: &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				  <span class=n>mss</span><span class=o>-&gt;</span><span class=n>private_hugetlb</span> <span class=o>&gt;&gt;</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Swap:           &#34;</span><span class=p>,</span> <span class=n>mss</span><span class=o>-&gt;</span><span class=n>swap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>SwapPss:        &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=n>mss</span><span class=o>-&gt;</span><span class=n>swap_pss</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>SEQ_PUT_DEC</span><span class=p>(</span><span class=s>&#34; kB</span><span class=se>\n</span><span class=s>Locked:         &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=n>mss</span><span class=o>-&gt;</span><span class=n>pss_locked</span> <span class=o>&gt;&gt;</span> <span class=n>PSS_SHIFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>seq_puts</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=s>&#34; kB</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Relevant section of linux kernel source:
<a href=https://sourcegraph.com/github.com/torvalds/linux/-/blob/fs/proc/task_mmu.c?L817:13 rel=noopener>https://sourcegraph.com/github.com/torvalds/linux/-/blob/fs/proc/task_mmu.c?L817:13</a></p><p>To solve this problem, I began searching for an alternative solution and found smaps_rollup just bellow in the source code. This more efficient alternative automatically sums up the data for me, eliminating the need for manual calculation. After replacing my original implementation with smaps_rollup, I was able to achieve an additional 35-40% performance improvement, bringing the runtime down to an impressive 30ms.</p><p>Final version of the method after minor adjustments:
<img src="/notes/assets/img/O_Pasted image 20230430231620.png" width=auto></p><a href=#conclusion><h2 id=conclusion><span class=hanchor arialabel=Anchor># </span>Conclusion:</h2></a><p>Throughout this optimization journey, I managed to reduce the runtime of my Rust program <code>zmem</code> from an initial 600ms down to just 30ms. By employing various optimization techniques, such as profiling with Cargo flamegraphs, parallelizing the Update function, improving data locality, reducing reduntant allocations, and switching to alternate ways to get data (<code>smaps_rollup</code>), I achieved a much faster and efficient program.</p><p>My experience with Rust has shown me the power of the language, and the optimization possibilities it offers. I&rsquo;m excited to continue exploring Rust and its performance capabilities, and I hope that my journey in optimizing <code>zmem</code> has provided you with some valuable insights for your own Rust projects.</p><p>Happy coding!</p><p>Source repo for Zmem:
<a href=https://github.com/xeome/Zmem rel=noopener>https://github.com/xeome/Zmem</a></p><a href=#see-also><h1 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h1></a><ul><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=455525" rel=noopener>https://bugs.chromium.org/p/chromium/issues/detail?id=455525</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/notes/Programming/ data-ctx="Optimizing Zmem" data-src=/notes/Programming class=internal-link>Programming stuff</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://notes.xeome.dev/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by xeome using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://notes.xeome.dev/>Home</a></li><li><a href=https://github.com/xeome>Github</a></li></ul></footer></div></div></body></html>