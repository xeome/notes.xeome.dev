<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Zram Performance Analysis Introduction Zram is a kernel module that utilizes a compressed virtual memory block device allowing for efficient memory management."><meta property="og:title" content="Zram"><meta property="og:description" content="Zram Performance Analysis Introduction Zram is a kernel module that utilizes a compressed virtual memory block device allowing for efficient memory management."><meta property="og:type" content="website"><meta property="og:image" content="https://xeome.github.io/icon.png"><meta property="og:url" content="https://xeome.github.io/notes/Zram/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Zram"><meta name=twitter:description content="Zram Performance Analysis Introduction Zram is a kernel module that utilizes a compressed virtual memory block device allowing for efficient memory management."><meta name=twitter:image content="https://xeome.github.io/icon.png"><title>Zram</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://xeome.github.io//icon.png><link href=https://xeome.github.io/styles.56fda312aefe26efb1fe5fe56affb512.min.css rel=stylesheet><link href=https://xeome.github.io/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://xeome.github.io/js/darkmode.7f967d9bd2d1cac02e762b5c57efc6ae.min.js></script>
<script src=https://xeome.github.io/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://xeome.github.io/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://xeome.github.io/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://xeome.github.io/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://xeome.github.io/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://xeome.github.io/",fetchData=Promise.all([fetch("https://xeome.github.io/indices/linkIndex.c4a3395cf6c38ca7c03221e0c541285a.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://xeome.github.io/indices/contentIndex.f7e4f39a558fa57aabb74efba056c593.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://xeome.github.io",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://xeome.github.io",t,[{"/moc":"#4388cc"}],t?{centerForce:.5,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:4,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/xeome.github.io\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=xeome.github.io src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://xeome.github.io/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://xeome.github.io/>Xeome's Notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Zram</h1><p class=meta>Last updated
Apr 16, 2023
<a href=https://github.com/xeome/xeome.github.io/tree/hugo/content/notes/Zram.md rel=noopener>Edit Source</a></p><ul class=tags></ul><a href=#zram-performance-analysis><h1 id=zram-performance-analysis><span class=hanchor arialabel=Anchor># </span>Zram Performance Analysis</h1></a><a href=#introduction><h2 id=introduction><span class=hanchor arialabel=Anchor># </span>Introduction</h2></a><p>Zram is a kernel module that utilizes a compressed virtual memory block device allowing for efficient memory management. In this document we will analyze the performance of various compression algorithms used in Zram and their impact on the system. We will also discuss the effects of different page-cluster values on the system&rsquo;s latencies and throughput.</p><a href=#compression-algorithm-comparison><h2 id=compression-algorithm-comparison><span class=hanchor arialabel=Anchor># </span>Compression Algorithm Comparison</h2></a><p>The following table compares the performance of different compression algorithms used in Zram, in terms of compression time, data size, compressed size, total size, and compression ratio.</p><p>Data from
<a href=https://linuxreviews.org/Zram rel=noopener>Linux Reviews</a>:</p><table><thead><tr><th style=text-align:center>Algorithm</th><th style=text-align:center>Cp time</th><th style=text-align:center>Data</th><th style=text-align:center>Compressed</th><th style=text-align:center>Total</th><th style=text-align:center>Ratio</th></tr></thead><tbody><tr><td style=text-align:center>lzo</td><td style=text-align:center>4.571s</td><td style=text-align:center>1.1G</td><td style=text-align:center>387.8M</td><td style=text-align:center>409.8M</td><td style=text-align:center>2.689</td></tr><tr><td style=text-align:center>lzo-rle</td><td style=text-align:center>4.471s</td><td style=text-align:center>1.1G</td><td style=text-align:center>388M</td><td style=text-align:center>410M</td><td style=text-align:center>2.682</td></tr><tr><td style=text-align:center>lz4</td><td style=text-align:center>4.467s</td><td style=text-align:center>1.1G</td><td style=text-align:center>403.4M</td><td style=text-align:center>426.4M</td><td style=text-align:center>2.582</td></tr><tr><td style=text-align:center>lz4hc</td><td style=text-align:center>14.584s</td><td style=text-align:center>1.1G</td><td style=text-align:center>362.8M</td><td style=text-align:center>383.2M</td><td style=text-align:center>2.872</td></tr><tr><td style=text-align:center>842</td><td style=text-align:center>22.574s</td><td style=text-align:center>1.1G</td><td style=text-align:center>538.6M</td><td style=text-align:center>570.5M</td><td style=text-align:center>1.929</td></tr><tr><td style=text-align:center>zstd</td><td style=text-align:center>7.897s</td><td style=text-align:center>1.1G</td><td style=text-align:center>285.3M</td><td style=text-align:center>298.8M</td><td style=text-align:center>3.961</td></tr></tbody></table><p>Data from u/VenditatioDelendaEst:</p><table><thead><tr><th style=text-align:center>algo</th><th style=text-align:center>page-cluster</th><th style=text-align:center>MiB/s</th><th style=text-align:center>IOPS</th><th style=text-align:center>Mean Latency (ns)</th><th style=text-align:center>99% Latency (ns)</th><th style=text-align:center>comp_ratio</th></tr></thead><tbody><tr><td style=text-align:center>lzo</td><td style=text-align:center>0</td><td style=text-align:center>5821</td><td style=text-align:center>1490274</td><td style=text-align:center>2428</td><td style=text-align:center>7456</td><td style=text-align:center>2.77</td></tr><tr><td style=text-align:center>lzo</td><td style=text-align:center>1</td><td style=text-align:center>6668</td><td style=text-align:center>853514</td><td style=text-align:center>4436</td><td style=text-align:center>11968</td><td style=text-align:center>2.77</td></tr><tr><td style=text-align:center>lzo</td><td style=text-align:center>2</td><td style=text-align:center>7193</td><td style=text-align:center>460352</td><td style=text-align:center>8438</td><td style=text-align:center>21120</td><td style=text-align:center>2.77</td></tr><tr><td style=text-align:center>lzo</td><td style=text-align:center>3</td><td style=text-align:center>7496</td><td style=text-align:center>239875</td><td style=text-align:center>16426</td><td style=text-align:center>39168</td><td style=text-align:center>2.77</td></tr><tr><td style=text-align:center>lzo-rle</td><td style=text-align:center>0</td><td style=text-align:center>6264</td><td style=text-align:center>1603776</td><td style=text-align:center>2235</td><td style=text-align:center>6304</td><td style=text-align:center>2.74</td></tr><tr><td style=text-align:center>lzo-rle</td><td style=text-align:center>1</td><td style=text-align:center>7270</td><td style=text-align:center>930642</td><td style=text-align:center>4045</td><td style=text-align:center>10560</td><td style=text-align:center>2.74</td></tr><tr><td style=text-align:center>lzo-rle</td><td style=text-align:center>2</td><td style=text-align:center>7832</td><td style=text-align:center>501248</td><td style=text-align:center>7710</td><td style=text-align:center>19584</td><td style=text-align:center>2.74</td></tr><tr><td style=text-align:center>lzo-rle</td><td style=text-align:center>3</td><td style=text-align:center>8248</td><td style=text-align:center>263963</td><td style=text-align:center>14897</td><td style=text-align:center>37120</td><td style=text-align:center>2.74</td></tr><tr><td style=text-align:center>lz4</td><td style=text-align:center>0</td><td style=text-align:center>7943</td><td style=text-align:center>2033515</td><td style=text-align:center>1708</td><td style=text-align:center>3600</td><td style=text-align:center>2.63</td></tr><tr><td style=text-align:center>lz4</td><td style=text-align:center>1</td><td style=text-align:center>9628</td><td style=text-align:center>1232494</td><td style=text-align:center>2990</td><td style=text-align:center>6304</td><td style=text-align:center>2.63</td></tr><tr><td style=text-align:center>lz4</td><td style=text-align:center>2</td><td style=text-align:center>10756</td><td style=text-align:center>688430</td><td style=text-align:center>5560</td><td style=text-align:center>11456</td><td style=text-align:center>2.63</td></tr><tr><td style=text-align:center>lz4</td><td style=text-align:center>3</td><td style=text-align:center>11434</td><td style=text-align:center>365893</td><td style=text-align:center>10674</td><td style=text-align:center>21376</td><td style=text-align:center>2.63</td></tr><tr><td style=text-align:center>zstd</td><td style=text-align:center>0</td><td style=text-align:center>2612</td><td style=text-align:center>668715</td><td style=text-align:center>5714</td><td style=text-align:center>13120</td><td style=text-align:center>3.37</td></tr><tr><td style=text-align:center>zstd</td><td style=text-align:center>1</td><td style=text-align:center>2816</td><td style=text-align:center>360533</td><td style=text-align:center>10847</td><td style=text-align:center>24960</td><td style=text-align:center>3.37</td></tr><tr><td style=text-align:center>zstd</td><td style=text-align:center>2</td><td style=text-align:center>2931</td><td style=text-align:center>187608</td><td style=text-align:center>21073</td><td style=text-align:center>48896</td><td style=text-align:center>3.37</td></tr><tr><td style=text-align:center>zstd</td><td style=text-align:center>3</td><td style=text-align:center>3005</td><td style=text-align:center>96181</td><td style=text-align:center>41343</td><td style=text-align:center>95744</td><td style=text-align:center>3.37</td></tr></tbody></table><p>Data from my raspberry pi 4, 2gb model:</p><table><thead><tr><th>algo</th><th style=text-align:center>page-cluster</th><th style=text-align:center>MiB/s</th><th style=text-align:center>IOPS</th><th style=text-align:center>Mean Latency (ns)</th><th style=text-align:center>99% Latency (ns)</th><th style=text-align:center>comp_ratio</th></tr></thead><tbody><tr><td>lzo</td><td style=text-align:center>0</td><td style=text-align:center>1275.19</td><td style=text-align:center>326448.93</td><td style=text-align:center>9965.14</td><td style=text-align:center>18816.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo</td><td style=text-align:center>1</td><td style=text-align:center>1892.08</td><td style=text-align:center>242186.68</td><td style=text-align:center>14178.77</td><td style=text-align:center>31104.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo</td><td style=text-align:center>2</td><td style=text-align:center>2451.65</td><td style=text-align:center>156905.52</td><td style=text-align:center>23083.55</td><td style=text-align:center>56064.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo</td><td style=text-align:center>3</td><td style=text-align:center>2786.33</td><td style=text-align:center>89162.46</td><td style=text-align:center>42224.49</td><td style=text-align:center>107008.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo-rle</td><td style=text-align:center>0</td><td style=text-align:center>1271.53</td><td style=text-align:center>325511.42</td><td style=text-align:center>9997.72</td><td style=text-align:center>20096.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo-rle</td><td style=text-align:center>1</td><td style=text-align:center>1842.69</td><td style=text-align:center>235863.95</td><td style=text-align:center>14627.23</td><td style=text-align:center>34048.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo-rle</td><td style=text-align:center>2</td><td style=text-align:center>2404.35</td><td style=text-align:center>153878.65</td><td style=text-align:center>23592.19</td><td style=text-align:center>60160.00</td><td style=text-align:center>1.62</td></tr><tr><td>lzo-rle</td><td style=text-align:center>3</td><td style=text-align:center>2766.61</td><td style=text-align:center>88531.46</td><td style=text-align:center>42579.14</td><td style=text-align:center>114176.00</td><td style=text-align:center>1.62</td></tr><tr><td>lz4</td><td style=text-align:center>0</td><td style=text-align:center>1329.87</td><td style=text-align:center>340447.83</td><td style=text-align:center>9421.35</td><td style=text-align:center>15936.00</td><td style=text-align:center>1.59</td></tr><tr><td>lz4</td><td style=text-align:center>1</td><td style=text-align:center>2004.43</td><td style=text-align:center>256567.19</td><td style=text-align:center>13238.78</td><td style=text-align:center>25216.00</td><td style=text-align:center>1.59</td></tr><tr><td>lz4</td><td style=text-align:center>2</td><td style=text-align:center>2687.75</td><td style=text-align:center>172015.93</td><td style=text-align:center>20807.00</td><td style=text-align:center>43264.00</td><td style=text-align:center>1.59</td></tr><tr><td>lz4</td><td style=text-align:center>3</td><td style=text-align:center>3157.29</td><td style=text-align:center>101033.42</td><td style=text-align:center>36901.36</td><td style=text-align:center>80384.00</td><td style=text-align:center>1.59</td></tr><tr><td>zstd</td><td style=text-align:center>0</td><td style=text-align:center>818.88</td><td style=text-align:center>209633.97</td><td style=text-align:center>16672.13</td><td style=text-align:center>38656.00</td><td style=text-align:center>1.97</td></tr><tr><td>zstd</td><td style=text-align:center>1</td><td style=text-align:center>1069.07</td><td style=text-align:center>136840.50</td><td style=text-align:center>26777.05</td><td style=text-align:center>69120.00</td><td style=text-align:center>1.97</td></tr><tr><td>zstd</td><td style=text-align:center>2</td><td style=text-align:center>1286.17</td><td style=text-align:center>82314.84</td><td style=text-align:center>46059.39</td><td style=text-align:center>127488.00</td><td style=text-align:center>1.97</td></tr><tr><td>zstd</td><td style=text-align:center>3</td><td style=text-align:center>1427.75</td><td style=text-align:center>45688.14</td><td style=text-align:center>84876.56</td><td style=text-align:center>246784.00</td><td style=text-align:center>1.97</td></tr></tbody></table><p>The table presents the performance metrics of different compression algorithms, including LZO, LZO-RLE, LZ4, and ZSTD. The metrics include throughput, compression ratio, and latency, which are important factors to consider for selecting the optimal compression algorithm.
<img src=/notes/assets/img/zram_weighed.png width=auto>
We used a weighted sum to evaluate the performance of each algorithm and page cluster combination, with weights of 0.4 for latency, 0.4 for compression ratio, and 0.2 for throughput. The results show that LZ4 with page cluster 0 achieved the highest weighted sum, indicating that it is the optimal choice for this dataset. Overall, this evaluation provides valuable insights for selecting the most suitable compression algorithm for data storage and processing, balancing between compression ratio, throughput, and latency.</p><p>Code used to calculate weighed sums:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>):</span> <span class=p>(</span><span class=mi>5821</span><span class=p>,</span> <span class=mf>2.77</span><span class=p>,</span> <span class=mi>2428</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span> <span class=p>(</span><span class=mi>6668</span><span class=p>,</span> <span class=mf>2.77</span><span class=p>,</span> <span class=mi>4436</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span> <span class=p>(</span><span class=mi>7193</span><span class=p>,</span> <span class=mf>2.77</span><span class=p>,</span> <span class=mi>8438</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span> <span class=p>(</span><span class=mi>7496</span><span class=p>,</span> <span class=mf>2.77</span><span class=p>,</span> <span class=mi>16426</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo-rle&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>):</span> <span class=p>(</span><span class=mi>6264</span><span class=p>,</span> <span class=mf>2.74</span><span class=p>,</span> <span class=mi>2235</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo-rle&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span> <span class=p>(</span><span class=mi>7270</span><span class=p>,</span> <span class=mf>2.74</span><span class=p>,</span> <span class=mi>4045</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo-rle&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span> <span class=p>(</span><span class=mi>7832</span><span class=p>,</span> <span class=mf>2.74</span><span class=p>,</span> <span class=mi>7710</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lzo-rle&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span> <span class=p>(</span><span class=mi>8248</span><span class=p>,</span> <span class=mf>2.74</span><span class=p>,</span> <span class=mi>14897</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lz4&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>):</span> <span class=p>(</span><span class=mi>7943</span><span class=p>,</span> <span class=mf>2.63</span><span class=p>,</span> <span class=mi>1708</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lz4&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span> <span class=p>(</span><span class=mi>9628</span><span class=p>,</span> <span class=mf>2.63</span><span class=p>,</span> <span class=mi>2990</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lz4&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span> <span class=p>(</span><span class=mi>10756</span><span class=p>,</span> <span class=mf>2.63</span><span class=p>,</span> <span class=mi>5560</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;lz4&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span> <span class=p>(</span><span class=mi>11434</span><span class=p>,</span> <span class=mf>2.63</span><span class=p>,</span> <span class=mi>10674</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;zstd&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>):</span> <span class=p>(</span><span class=mi>2612</span><span class=p>,</span> <span class=mf>3.37</span><span class=p>,</span> <span class=mi>5714</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;zstd&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span> <span class=p>(</span><span class=mi>2816</span><span class=p>,</span> <span class=mf>3.37</span><span class=p>,</span> <span class=mi>10847</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;zstd&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span> <span class=p>(</span><span class=mi>2931</span><span class=p>,</span> <span class=mf>3.37</span><span class=p>,</span> <span class=mi>21073</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;zstd&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span> <span class=p>(</span><span class=mi>3005</span><span class=p>,</span> <span class=mf>3.37</span><span class=p>,</span> <span class=mi>41343</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>weights</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;latency&#39;</span><span class=p>:</span> <span class=mf>0.4</span><span class=p>,</span> <span class=s1>&#39;ratio&#39;</span><span class=p>:</span> <span class=mf>0.4</span><span class=p>,</span> <span class=s1>&#39;throughput&#39;</span><span class=p>:</span> <span class=mf>0.2</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Find the maximum value for each metric</span>
</span></span><span class=line><span class=cl><span class=n>max_throughput</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>max_ratio</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>max_latency</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>best_score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>best_algo</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=n>best_page_cluster</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>algo</span><span class=p>,</span> <span class=n>page_cluster</span><span class=p>),</span> <span class=p>(</span><span class=n>throughput</span><span class=p>,</span> <span class=n>ratio</span><span class=p>,</span> <span class=n>latency</span><span class=p>)</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>throughput_norm</span> <span class=o>=</span> <span class=n>throughput</span> <span class=o>/</span> <span class=n>max_throughput</span>
</span></span><span class=line><span class=cl>    <span class=n>ratio_norm</span> <span class=o>=</span> <span class=n>ratio</span> <span class=o>/</span> <span class=n>max_ratio</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_norm</span> <span class=o>=</span> <span class=n>latency</span> <span class=o>/</span> <span class=n>max_latency</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span> <span class=o>=</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;latency&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=n>latency_norm</span><span class=p>)</span> <span class=o>+</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;ratio&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>ratio_norm</span> <span class=o>+</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;throughput&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>throughput_norm</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>algo</span><span class=si>}</span><span class=s2>, pagecluster </span><span class=si>{</span><span class=n>page_cluster</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>best_score</span> <span class=o>=</span> <span class=n>score</span>
</span></span><span class=line><span class=cl>        <span class=n>best_algo</span> <span class=o>=</span> <span class=n>algo</span>
</span></span><span class=line><span class=cl>        <span class=n>best_page_cluster</span> <span class=o>=</span> <span class=n>page_cluster</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Best algorithm: </span><span class=si>{</span><span class=n>best_algo</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Best page cluster: </span><span class=si>{</span><span class=n>best_page_cluster</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Data from me:</p><p>Compiling memory intensive code (
<a href=https://github.com/netxs-group/vtm rel=noopener>vtm</a> ). Test was done on raspberry pi 4b, 2gb ram.</p><table><thead><tr><th style=text-align:center>algo</th><th style=text-align:center>time</th></tr></thead><tbody><tr><td style=text-align:center>lz4</td><td style=text-align:center>433.63s</td></tr><tr><td style=text-align:center>zstd</td><td style=text-align:center>459.34s</td></tr></tbody></table><a href=#page-cluster-values-and-latency><h3 id=page-cluster-values-and-latency><span class=hanchor arialabel=Anchor># </span>Page-cluster Values and Latency</h3></a><p>The page-cluster value controls the number of pages that are read in from swap in a single attempt, similar to the page cache readahead. The consecutive pages are not based on virtual or physical addresses, but consecutive on swap space, meaning they were swapped out together.</p><p>The page-cluster value is a logarithmic value. Setting it to zero means one page, setting it to one means two pages, setting it to two means four pages, etc. A value of zero disables swap readahead completely.</p><p>The default value is 3 (8 pages at a time). However, tuning this value to a different value may provide small benefits if the workload is swap-intensive. Lower values mean lower latencies for initial faults, but at the same time, extra faults and I/O delays for following faults if they would have been part of that consecutive pages readahead would have brought in.</p><p><img src=/notes/assets/img/O_benchmarks_zram_throughput.png width=auto></p><p><img src=/notes/assets/img/O_benchmarks_zram_latency.png width=auto></p><a href=#conclusion><h2 id=conclusion><span class=hanchor arialabel=Anchor># </span>Conclusion</h2></a><p>In the analysis of Zram performance, it was determined that the zstd algorithm provides the highest compression ratio while still maintaining acceptable speeds. The high compression ratio allows more of the working set to fit in uncompressed memory, reducing the need for swap and ultimately improving performance.</p><p>For daily use (non latency sensitive), it is recommended to use zstd with <code>page-cluster=0</code> as the majority of swapped data is likely stale (old browser tabs). However, systems that require constant swapping may benefit from using the lz4 algorithm due to its higher throughput and lower latency.</p><p>It is important to note that the decompression of zstd is slow and results in a lack of throughput gain from readahead. Therefore, <code>page-cluster=0</code> should be used for zstd. This is the default setting on
<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=263561#c16=" rel=noopener>ChromeOS</a> and seems to be standard practice on
<a href="https://cs.android.com/search?q=page-cluster&start=21" rel=noopener>Android</a>.</p><p>The default <code>page-cluster</code> value is set to 3, which is better suited for physical swap. This value dates back to 2005, when the kernel switched to git, and may have been used in a time before the widespread use of SSDs. It is recommended to consider the specific requirements of the system and workload when configuring Zram.</p><a href=#sources-and-see-also><h1 id=sources-and-see-also><span class=hanchor arialabel=Anchor># </span>Sources and See Also</h1></a><p><a href=https://linuxreviews.org/Zram rel=noopener>https://linuxreviews.org/Zram</a></p><p><a href=https://docs.kernel.org/admin-guide/sysctl/vm.html rel=noopener>https://docs.kernel.org/admin-guide/sysctl/vm.html</a></p><p><a href=https://www.reddit.com/r/Fedora/comments/mzun99/new_zram_tuning_benchmarks/ rel=noopener>https://www.reddit.com/r/Fedora/comments/mzun99/new_zram_tuning_benchmarks/</a></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/notes/JomOS-Optimizations/ data-ctx=notes/Zram data-src=/notes/JomOS-Optimizations class=internal-link>JomOS Optimizations</a></li><li><a href=/notes/Linux/ data-ctx=notes/Zram data-src=/notes/Linux class=internal-link>Linux</a></li><li><a href=/notes/Post-install-optimizations/ data-ctx=notes/Zram data-src=/notes/Post-install-optimizations class=internal-link>Post install Optimizations</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://xeome.github.io/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by xeome using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://xeome.github.io/>Home</a></li><li><a href=https://github.com/xeome>Github</a></li></ul></footer></div></div></body></html>